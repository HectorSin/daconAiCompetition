# 테스트 보고서 - 실제 데이터 분석

**생성일:** 2025-11-11
**환경:** daconai (Python 3.10.19)

---

## 1. 단위 테스트 결과: 24/25 통과 ✓

### 요약
- **전체 테스트:** 25개
- **통과:** 24개 (96%)
- **실패:** 1개 (4%)
- **경고:** 4개 (KPSS p-value 경고, 중요하지 않음)

### 테스트 세부 내역

#### 공행성 탐지 (11/12 통과)
- ✓ CCF 계산 및 행렬 연산
- ✓ Granger 인과관계 행렬
- ✓ DTW 거리 계산
- ✓ FDR 보정 (다중 검정)
- ✓ 종합 공행성 탐지
- ✓ 엣지 케이스 (결측값, 전부/전무 유의)
- ✗ **실패:** `test_calculate_granger_causality` - `np.True_` 반환 (Python `bool` 대신)

#### 전처리 (6/6 통과)
- ✓ 데이터 피벗 (long to wide 형식)
- ✓ 음수값 탐지
- ✓ 이상치 로깅

#### 정상성 테스트 (7/7 통과)
- ✓ ADF 테스트
- ✓ KPSS 테스트
- ✓ STL 분해
- ✓ 결측값 처리

---

## 2. 실제 데이터 구조 분석

### 원본 데이터 스키마
```
컬럼: item_id, year, month, seq, type, hs4, weight, quantity, value
행 수: 10,836
```

**더미 데이터와의 주요 차이점:**
1. **`date` 컬럼 없음** - `year` + `month`로 분리되어 있음 (date 생성 필요)
2. **월별 item당 여러 행** - `seq` 컬럼이 월별 1-3개의 거래를 나타냄
3. **추가 메타데이터:**
   - `type`: 모든 행이 1 (단일 무역 유형)
   - `hs4`: 71개의 고유한 HS 코드 (무역 분류)
   - `weight`, `quantity`: `value` 외 대체 측정값

### 집계 후 데이터 (월별 합계)

**형태:** 43개월 × 100개 품목

**완전성:**
- 예상 데이터 포인트: 4,300개 (43 × 100)
- 실제 데이터 포인트: 3,776개
- **결측값: 524개 (12.2%)**

**결측 데이터가 있는 품목:**
- 100개 품목 중 33개가 최소 1개월 이상 결측
- 최악의 경우: GMBFCMIU (43개월 중 42개월 결측)
- 5개 품목이 37-42개월 결측 (거의 전체 결측)

**값 통계:**
- 최소값: 1
- 최대값: 146,216,818
- 평균: 4,491,328
- 중앙값: 271,322
- 0값 없음 (결측 데이터 필터링 후)

**시간 범위:**
- 시작: 2022-01
- 종료: 2025-07
- 총: 43개월

---

## 3. 발견된 문제점

### 중요 문제

1. **전처리 파이프라인 불일치**
   - 현재 `load_data()` 기대값: `(date, item_code, value)`
   - 실제 데이터: `(year, month, item_id, seq, type, hs4, weight, quantity, value)`
   - **필요 조치:** 실제 스키마 처리하도록 전처리 업데이트

2. **월별 다중 거래**
   - 원본 데이터에 (품목, 월) 조합당 1-3개 행 존재
   - **필요 조치:** 피벗 전 집계 단계 추가
   - **권장사항:** SUM 집계 사용 (월별 총 무역량)

3. **상당한 결측 데이터 (12.2%)**
   - 33개 품목이 불완전한 시계열
   - 일부 품목은 데이터가 거의 없음 (1-5개 데이터 포인트만)
   - **필요 조치:** 처리 전략 결정:
     - X% 이상 결측인 품목 제거
     - 보간 (forward-fill, 선형 보간)
     - 결측 데이터를 자체적으로 처리하는 모델 사용

### 경미한 문제

4. **Granger 인과관계 테스트가 Numpy Bool 반환**
   - 파일: `tests/test_comovement.py:111`
   - 문제: `result['is_causal']`이 Python `bool`이 아닌 `np.True_`
   - **수정:** `src/comovement.py`에 `.item()` 또는 `bool()` 변환 추가

5. **KPSS 테스트 경고**
   - p-value가 조회 테이블 범위를 벗어난다는 경고 4개
   - 매우 정상적인 데이터에 대한 예상 동작
   - 중요하지 않음, 억제 가능

---

## 4. 필요한 조치사항

### 즉시 처리 (학습 전)

1. **`src/preprocess.py` 업데이트:**
   - `aggregate_transactions()` 함수 추가
   - `load_data()`를 `(year, month)` → `date` 변환 처리하도록 수정
   - `preprocess_pipeline()`에 집계 단계 포함

2. **Granger 테스트 수정:**
   - `src/comovement.py`를 Python bool 반환하도록 업데이트

3. **결측 데이터 전략 결정:**
   - 유지/제거할 품목 분석
   - 필요시 보간 구현

### 권장 다음 단계

4. **새 EDA 노트북 생성:**
   - `notebooks/04_real_data_eda.ipynb`
   - 샘플 품목의 시계열 시각화
   - 결측 패턴 분석
   - `value` vs `weight` vs `quantity` 컬럼 비교

5. **설정 업데이트:**
   - `config.py`에 집계 전략 추가
   - 결측 데이터 임계값 추가
   - 사용할 값 컬럼 문서화 (value/weight/quantity)

6. **테스트 업데이트:**
   - 집계 함수에 대한 테스트 추가
   - 결측 데이터 처리에 대한 테스트 추가

7. **추가 컬럼 활용 고려:**
   - `hs4` 코드는 유용한 특징이 될 수 있음 (무역 카테고리)
   - `weight`와 `quantity`가 예측 개선에 도움될 수 있음

---

## 5. 정상 작동하는 것 ✓

- 모든 공행성 탐지 함수 (CCF, Granger, DTW, FDR)
- 정상성 테스트 (ADF, KPSS, STL 분해)
- 데이터 품질 체크 (음수, 이상치)
- 피벗 로직 (데이터 집계 후)
- 테스트 인프라

---

## 6. 권장사항

### 단기
1. 실제 데이터 스키마 처리하도록 전처리 파이프라인 수정
2. 실제 데이터로 전체 EDA 수행
3. 결측 데이터 전략 결정

### 중기
1. 실제 데이터 구조로 특징 공학 완료
2. 12.2% 결측 데이터로 예측 모델 테스트
3. `weight`와 `quantity`를 대체 타겟으로 실험

### 장기
1. HS4 코드를 범주형 특징으로 사용 고려
2. 희소 품목 처리를 위한 앙상블 방법 탐색
3. 공행성 패턴을 활용한 교차 품목 보간 구현

---

## 7. 빠른 시작 명령어

```bash
# 모든 테스트 실행
/c/Users/SMART/anaconda3/envs/daconai/python.exe -m pytest tests/ -v

# 실제 데이터로 전처리 테스트 (수정 후)
/c/Users/SMART/anaconda3/envs/daconai/python.exe src/preprocess.py

# EDA 노트북 시작
conda activate daconai
jupyter lab notebooks/04_real_data_eda.ipynb
```

---

**현재 상태:** 전처리 업데이트 및 EDA 진행 준비 완료
